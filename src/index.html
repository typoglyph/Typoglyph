<!DOCTYPE html>
<html>
<head>
	<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
	<meta content="utf-8" http-equiv="encoding">
	<title>Typoglyph</title>
	
	<link rel="stylesheet" type="text/css" href="styles/common.css">
	<link rel="stylesheet" type="text/css" href="styles/index.css">
	
	<script>
	var currentPuzzle = null;
	var correctAnswers = 0;
	var totalAnswers = 0;
	
	
	function onFinishPuzzle() {
		var blanks = document.getElementsByClassName("blankSpace");
		var allFilled = true;
		for (blank of blanks) {
			if (blank.innerHTML == "") {
				allFilled = false;
				blank.className += " empty";
			}
		}
		if (allFilled) {
			checkAnswer();
			displayRandomPuzzle();
		}
	}
	
	function checkAnswer() {
		var sentence = currentPuzzle.sentence;
		var blanks = document.getElementsByClassName("blankSpace");
		
		var index = 0;
		var open = false;
		var allBlanksCorrect = true;
		for (blank of blanks) {
			var givenAnswer = blank.childNodes[0].innerHTML;
			var actualAnswer = '';
			while (true) {
				c = sentence[index];
				if (!open && c == "{") {
					open = true;
				} else if (open && c == "}" && sentence[index + 1] != "}") {
					open = false;
					break;
				} else if (open) {
					// keep appending until we find the "close" character
					actualAnswer += c;
				} else {
					// do nothing until we find the "open" character
				}
				index++;
			}
			
			if (givenAnswer != actualAnswer) {
				allBlanksCorrect = false;
				break;
			}
		}
		
		var answerElement = document.getElementById("answer");
		var correctAnswersElement = document.getElementById("correctAnswers");
		var totalAnswersElement = document.getElementById("totalAnswers");
		
		totalAnswers++;
		if (allBlanksCorrect) {
			answerElement.innerHTML = "Correct";
			answerElement.className = "correct";
			correctAnswers++;
		} else {
			answerElement.innerHTML = "Incorrect";
			answerElement.className = "incorrect";
		}
		
		correctAnswersElement.innerHTML = ("" + correctAnswers);
		totalAnswersElement.innerHTML = ("" + totalAnswers);
	}
	
	function displayRandomPuzzle() {		
		var httpReq = new XMLHttpRequest();
		httpReq.onreadystatechange = function() {
			if (httpReq.readyState == 4 && httpReq.status == 200) {
				var puzzle = JSON.parse(httpReq.responseText)[0];
				var sentence = "";
				var replacement = false;
				for (var i = 0; i < puzzle.sentence.length; i++) {
					if (!replacement && puzzle.sentence[i] == "{") {
						replacement = true;
					} else if (replacement && puzzle.sentence[i] == "}" && puzzle.sentence[i + 1] != "}") {
						replacement = false;
					} else if (replacement) {
						sentence += "<span class='blankSpace' ondrop='drop(event);' ondragover='allowDrop(event);'>";
						sentence += "</span>";
					} else {
						sentence += puzzle.sentence[i];
					}
				}
				
				var options = "";
				for (var i = 0; i < puzzle.options.length; i++) {
					id = "option" + i;
					options += "<span class='draggableOption stored' draggable='true' ondragstart='drag(event);'>";
					options += puzzle.options[i];
					options += "</span>";
				}
				
				// Modify the global state to reflect the new puzzle
				currentPuzzle = puzzle;
				document.getElementById("options").innerHTML = options;
				document.getElementById("sentence").innerHTML = sentence;
			}
		};
		httpReq.open("GET", "backend/getRandomPuzzles.php?count=1", true);
		httpReq.send();
	}
	
	function allowDrop(ev) {
		ev.preventDefault();
	}

	function drag(ev) {
		ev.dataTransfer.setData("text", ev.target.outerHTML);
	}

	function drop(ev) {
		ev.preventDefault();
		
		var data = ev.dataTransfer.getData("text");
		var target = ev.target;
		while (target != null && !isElementOfClass(target, "blankSpace")) {
			// If it's an "option" placed on top of a "blank", we need to find the parent "blank" to replace the HTML of
			target = target.parentNode;
		}
		target.innerHTML = data;
		removeClassFromElement(target, "empty");
		removeClassFromElement(target.childNodes[0], "stored");
	}
	
	function isElementOfClass(e, className) {
		var regExp = new RegExp("(^| )" + className + "($| )");
		return e.className.match(regExp);
	}
	
	function removeClassFromElement(e, className) {
		var regExp = new RegExp("(^| )" + className + "($| )");
		e.className = e.className.replace(regExp, "");
	}
	</script>
</head>
<body onload="displayRandomPuzzle();">
	<table>
		<tr>
			<td>Previous puzzle:</td>
			<td><span id="answer">N/A</span></td>
		</td>
		<tr>
			<td>Score:</td>
			<td><span id="correctAnswers">0</span> / <span id="totalAnswers">0</span></td>
		</tr>
		<tr>
			<td>Options:</td>
			<td><span id="options"/></td>
		</tr>
		<tr>
			<td>Sentence:</td>
			<td><span id="sentence"/></td>
		</tr>
		<tr>
			<td><button id="nextPuzzle" class="button" onclick="onFinishPuzzle();">Check answer | Next puzzle</button></td>
		</tr>
		<tr>
			<td><a href="rawData.html">View raw data</a></td>
			<td><a href="info.php">View PHP info</a></td>
		</tr>
	</table>
</body>
</html>
